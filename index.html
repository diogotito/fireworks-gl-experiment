<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fireworks GL</title>
    <link rel="stylesheet" href="style.css">

    <script type="module" src="script.mjs"></script>

    <script id="fireworks_vs" type="text/x-vertex-shader">
        uniform float time;

        attribute float lifetime;
        attribute float timeOffset;
        attribute vec2 startPos;
        attribute vec2 startVel;
        attribute vec2 acc;
        attribute float startSize;
        attribute float endSize;
        attribute vec4 startColor;
        attribute vec4 endColor;

        varying vec4 vCurrColor;
        
        void main(void) {
            float particleTime = time + timeOffset - lifetime;
            particleTime *= 4.0;
            float loopTime = mod(particleTime, lifetime);
            float progress = fract(particleTime / lifetime);

            // Closed-form projectile equation
            // https://www.sci.brooklyn.cuny.edu/~meyer/CISC3600/Materials/4_3Real_Time_Physics.pdf
            vec2 pos = startPos;
            pos += startVel * loopTime;
            pos += 0.5 * (acc * loopTime * loopTime);

            // Scale/offset some stuff
            pos *= 0.02;

            vec4 color = startColor + progress * (endColor - startColor);
            float alpha = clamp(particleTime, 0.0, 1.0);
            vCurrColor = vec4(color.rgb, alpha * color.a);
            gl_Position = vec4(pos, 0.0, 1.0);
            gl_PointSize = startSize + progress * (endSize - startSize);
        }
    </script>

    <script id="fireworks_fs" type="text/x-fragment-shader">
        precision mediump float;

        varying vec4 vCurrColor;

        const vec4 bgColor = vec4(0.3, 0.1, 0.4, 1.0);

        void main(void) {
            float dist_center = distance(gl_PointCoord, vec2(0.5));
            float dist_clamped = 2.0 * min(0.5, dist_center);
            float alpha = pow(1.-dist_clamped, 4.0);
            gl_FragColor = vec4(vCurrColor.rgb, alpha * vCurrColor.a);
        }
    </script>
</head>
<body>
    <canvas id="fireworks"></canvas>
</body>
</html>